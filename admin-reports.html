<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registrar â€” Reports</title>
<style>
  :root{--ink:#e5e7eb;--muted:#94a3b8;--card:#0b1324;--line:#1f2937;--bg:#0b1220;--accent:#22c55e;--danger:#ef4444}
  *{box-sizing:border-box}body{margin:0;font:15px/1.48 system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:36px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:22px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 10px}.muted{color:var(--muted)}
  label{display:block;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--ink)}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--accent);color:#031}
  .ghost{background:#1f2937;color:#e5e7eb}
  .danger{background:var(--danger);color:#ffe4e6}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;text-align:left;vertical-align:top}
  thead th{color:#cbd5e1}
  tbody tr{background:var(--card);border:1px solid var(--line)}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b172e;border:1px solid #24324a;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<script>(function(){ if(localStorage.getItem('regAdmin')!=='1') location.replace('/admin-login.html'); })();</script>
<div class="wrap">
  <div class="card">
    <h1>Reports</h1>
    <div class="toolbar">
      <input id="from" type="date"> <span class="muted">to</span>
      <input id="to" type="date">
      <button class="ghost" id="go">Generate</button>
      <button class="ghost" id="expW">Export Weekly (CSV)</button>
      <button class="ghost" id="expM">Export Monthly (CSV)</button>
      <button class="ghost" id="expT">Export Tickets (CSV)</button>
      <a class="ghost" href="/admin-entry.html" style="text-decoration:none;padding:10px 14px;border-radius:10px">Entry</a>
      <a class="ghost" href="/admin-update.html" style="text-decoration:none;padding:10px 14px;border-radius:10px">Update</a>
    </div>
    <h3>Weekly Summary</h3>
    <table><thead><tr>
      <th>Week Covered</th><th>Start</th><th>End</th><th>Total Requests</th><th>Avg Proc. Time</th><th>Completed</th><th>Target (avg)</th><th>Fastest</th><th>Longest</th><th>% Within Target</th>
    </tr></thead><tbody id="weekly"></tbody></table>
    <h3 style="margin-top:18px">Monthly Consolidation</h3>
    <table><thead><tr>
      <th>Month</th><th>Target (avg)</th><th>Actual Avg</th><th>Variance</th><th>Completed</th>
    </tr></thead><tbody id="monthly"></tbody></table>
  </div>
</div>
<script>
let _weekly=[], _monthly=[];
const $w=document.getElementById('weekly'), $m=document.getElementById('monthly');
async function readErr(r){const ct=r.headers.get('content-type')||'';if(ct.includes('application/json')){try{const j=await r.json();return j.error||JSON.stringify(j)}catch{}}try{return (await r.text()).slice(0,400)}catch{return r.statusText}}
function fmt(d){return new Date(d).toLocaleDateString();}
document.getElementById('go').onclick=async()=>{
  const p=new URLSearchParams(); if(from.value) p.set('from', from.value); if(to.value) p.set('to', to.value);
  const rw=await fetch('/api/reports/weekly?'+p.toString()); if(!rw.ok) return alert(await readErr(rw)); const w=await rw.json();
  const rm=await fetch('/api/reports/monthly?'+p.toString()); if(!rm.ok) return alert(await readErr(rm)); const m=await rm.json();
  _weekly = w; _monthly = m;
  $w.textContent=''; for(const r of w){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.week}</td><td>${fmt(r.start)}</td><td>${fmt(r.end)}</td><td>${r.total}</td><td>${(r.avg||0).toFixed(2)}</td><td>${r.completed}</td><td>${(r.targetAvg||0).toFixed(2)}</td><td>${(r.fastest||0).toFixed(2)}</td><td>${(r.longest||0).toFixed(2)}</td><td>${(r.pctWithin||0).toFixed(0)}%</td>`; $w.appendChild(tr); }
  $m.textContent=''; for(const r of m){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.month}</td><td>${(r.targetAvg||0).toFixed(2)}</td><td>${(r.actualAvg||0).toFixed(2)}</td><td>${((r.actualAvg||0)-(r.targetAvg||0)).toFixed(2)}</td><td>${r.completed}</td>`; $m.appendChild(tr); }
};

function toCSV(headers, rows){
  const csv=[headers.join(',')];
  for(const r of rows){
    csv.push(headers.map(h=>{
      let v = (r[h]!==undefined && r[h]!==null) ? String(r[h]) : '';
      return '"' + v.replace(/"/g,'""') + '"';
    }).join(','));
  }
  const blob=new Blob([csv.join('\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='export.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
}

document.getElementById('expW').onclick=()=>{
  if(!_weekly.length){ alert('Generate a report first.'); return; }
  const rows = _weekly.map(r=>({
    week:r.week,
    start:new Date(r.start).toISOString(),
    end:new Date(r.end).toISOString(),
    total:r.total??'',
    avg:(r.avg??'').toString(),
    completed:r.completed??'',
    targetAvg:(r.targetAvg??'').toString(),
    fastest:(r.fastest??'').toString(),
    longest:(r.longest??'').toString(),
    pctWithin:(r.pctWithin??'').toString()
  }));
  toCSV(['week','start','end','total','avg','completed','targetAvg','fastest','longest','pctWithin'], rows);
};

document.getElementById('expM').onclick=()=>{
  if(!_monthly.length){ alert('Generate a report first.'); return; }
  const rows = _monthly.map(r=>({
    month:r.month,
    targetAvg:(r.targetAvg??'').toString(),
    actualAvg:(r.actualAvg??'').toString(),
    variance:(((r.actualAvg||0)-(r.targetAvg||0))).toString(),
    completed:r.completed??''
  }));
  toCSV(['month','targetAvg','actualAvg','variance','completed'], rows);
};

document.getElementById('expT').onclick=async()=>{
  try{
    const p=new URLSearchParams();
    if(from.value) p.set('from', from.value);
    if(to.value) p.set('to', to.value);
    p.set('limit','1000');
    const r=await fetch('/api/ticket?'+p.toString());
    if(!r.ok) return alert(await r.text());
    const rows=await r.json();
    if(!rows.length) return alert('No tickets in this range.');
    const headers=['_id','ref','studentId','studentName','requestType','dateReceived','scheduleRelease','dateRelease','processingDays','targetDays','remarks','staff','status','createdAt'];
    const norm = rows.map(t=>{ const o={}; headers.forEach(h=>o[h]=t[h]??''); return o; });
    toCSV(headers, norm);
  }catch(e){ alert(String(e)); }
};
</script>
</body></html>
