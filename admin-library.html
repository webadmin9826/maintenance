<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Library Admin — Logs</title>
<style>
  :root{--ink:#e5e7eb;--muted:#94a3b8;--card:#0b1324;--line:#1f2937;--bg:#0b1220;--accent:#22c55e;--danger:#ef4444}
  *{box-sizing:border-box}body{margin:0;font:15px/1.48 system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1200px;margin:32px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  input,select{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--ink)}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .ghost{background:#1f2937;color:#e5e7eb}
  .primary{background:var(--accent);color:#031}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;text-align:left;vertical-align:top}
  thead th{color:#cbd5e1}
  tbody tr{background:var(--card);border:1px solid var(--line)}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<!-- If you have a library login, keep this gate; otherwise comment it out -->
<script>(function(){ if(localStorage.getItem('libraryAdmin')!=='1') {/* location.replace('/library-login.html');*/} })();</script>

<div class="wrap">
  <div class="card">
    <h1>Library Logs</h1>
    <div class="toolbar">
      <input id="q" placeholder="Search name, purpose, course…" style="min-width:280px">
      <select id="purposeFilter">
        <option value="">All Purposes</option>
        <option>To Review</option>
        <option>Borrow Books</option>
        <option>Return Books</option>
        <option>To Read</option>
        <option>To Find Books</option>
        <option>To Study</option>
        <option>To do Research/thesis</option>
        <option>To do activities</option>
        <option>Signing of clearance</option>
      </select>
      <select id="courseFilter">
        <option value="">All Courses</option>
        <option>BSN</option><option>BSMid</option><option>BSIT</option><option>BSP</option><option>BSRT</option>
      </select>
      <button class="ghost" id="refresh">Refresh</button>
      <button class="primary" id="export">Export CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:120px">Date</th>
          <th style="width:90px">Time In</th>
          <th style="width:220px">Name</th>
          <th style="width:120px">Year Level</th>
          <th style="width:100px">Course</th>
          <th style="width:200px">Purpose</th>
          <th>Extra</th>
          <th style="width:90px">Via</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <p id="count" class="muted" style="margin-top:8px"></p>
  </div>
</div>

<script>
const $rows = document.getElementById('rows');
const $q = document.getElementById('q');
const $purposeFilter = document.getElementById('purposeFilter');
const $courseFilter = document.getElementById('courseFilter');
const $count = document.getElementById('count');

async function readErr(r){
  const ct=r.headers.get('content-type')||'';
  if(ct.includes('application/json')){
    try{const j=await r.json();return j.error||JSON.stringify(j)}catch{}
  }
  try{return (await r.text()).slice(0,400)}catch{return r.statusText}
}

async function fetchLogs(){
  const params = new URLSearchParams();
  if ($q.value.trim()) params.set('q', $q.value.trim());
  if ($purposeFilter.value) params.set('purpose', $purposeFilter.value);
  if ($courseFilter.value) params.set('course', $courseFilter.value);
  // ✅ Call the merged endpoint route (handled by /api/ticket/[id].js with id === 'logs')
  const r = await fetch('/api/ticket/logs?'+params.toString());
  if (!r.ok) throw new Error(await readErr(r));
  return r.json();
}

function render(list){
  $rows.textContent = '';
  if (!list.length){
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=8; td.textContent='No records.'; td.className='muted';
    tr.appendChild(td); $rows.appendChild(tr);
    $count.textContent = '0 record(s).';
    return;
  }
  for (const t of list){
    const tr = document.createElement('tr');
    function td(txt){ const e=document.createElement('td'); e.textContent = txt||''; return e; }
    tr.append(
      td(t.date),
      td(t.timeIn),
      td(t.name),
      td(t.yearLevel),
      td(t.course),
      td(t.purpose),
      td(t.extra),
      td(t.via)
    );
    $rows.appendChild(tr);
  }
  $count.textContent = `${list.length} record(s).`;
}

async function refresh(){
  try{
    // show loading row
    $rows.innerHTML = '';
    const tr=document.createElement('tr'); const td=document.createElement('td');
    td.colSpan=8; td.textContent='Loading…'; td.className='muted';
    tr.appendChild(td); $rows.appendChild(tr);

    const list = await fetchLogs();
    render(list);
  }catch(e){ alert(String(e)); }
}

document.getElementById('refresh').onclick = refresh;
$q.addEventListener('keydown', e=>{ if(e.key==='Enter') refresh(); });
$purposeFilter.onchange = refresh;
$courseFilter.onchange = refresh;

document.getElementById('export').onclick = async ()=>{
  try{
    const list = await fetchLogs();
    if (!list.length) return alert('No data to export.');
    const headers = ['date','timeIn','name','yearLevel','course','purpose','extra','via','_id'];
    const csv = [headers.join(',')];
    for (const r of list){
      csv.push(headers.map(h => `"${((r[h]??'')+'').replace(/"/g,'""')}"`).join(','));
    }
    const blob = new Blob([csv.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'library-logs.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
  }catch(e){ alert(String(e)); }
};

// initial
refresh();
</script>
</body>
</html>
