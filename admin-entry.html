<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registrar â€” Log Incoming / Outgoing (Fixed)</title>
<style>
  :root{--ink:#e5e7eb;--muted:#94a3b8;--card:#0b1324;--line:#1f2937;--bg:#0b1220;--accent:#22c55e;--danger:#ef4444}
  *{box-sizing:border-box}body{margin:0;font:15px/1.48 system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1100px;margin:36px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:22px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 10px}.muted{color:var(--muted)}
  label{display:block;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--ink)}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .primary{background:var(--accent);color:#031}
  .ghost{background:#1f2937;color:#e5e7eb}
  .danger{background:var(--danger);color:#ffe4e6}
</style>
</head>
<body>
<script>(function(){ if(localStorage.getItem('regAdmin')!=='1') location.replace('/admin-login.html'); })();</script>
<div class="wrap">
  <div class="card">
    <h1>Incoming / Outgoing Requests</h1>
    <p class="muted">Fields follow the daily log template.</p>
    <form id="form">
      <div class="row">
        <div><label>Student ID</label><input id="sid"></div>
        <div><label>Student Name *</label><input id="sname" required></div>
        <div><label>Type of Request *</label><input id="rtype" required placeholder="e.g., Transcript, TOR, Certificate"></div>
        <div><label>Date Received *</label><input id="dr" type="datetime-local" required></div>
        <div><label>Schedule for Release</label><input id="sched" type="datetime-local"></div>
        <div><label>Target Time (Days)</label><input id="target" type="number" min="0" step="1" placeholder="e.g., 3"></div>
        <div><label>Staff In-Charge</label><input id="staff"></div>
      </div>
      <label>Remarks</label><textarea id="remarks" placeholder="Notes / special instructions"></textarea>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="primary" type="submit">Save as Incoming</button>
        <button class="ghost" type="button" id="saveOutgoing">Save as Outgoing (Released Now)</button>
        <a class="ghost" href="/admin-update.html" style="text-decoration:none;padding:10px 14px;border-radius:10px">Go to Update</a>
        <a class="ghost" href="/admin-reports.html" style="text-decoration:none;padding:10px 14px;border-radius:10px">Reports</a>
        <button class="ghost" type="button" id="exportBtn">Export (CSV)</button>
      </div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </form>
  </div>

  <!-- Bulk Import (CSV) -->
  <div class="card" style="margin-top:16px">
    <h2>Bulk Import (CSV)</h2>
    <p class="muted">Download the template, populate rows, then import here. Required fields: <strong>studentName</strong>, <strong>requestType</strong>, <strong>dateReceived</strong>. Optional: studentId, scheduleRelease, targetDays, remarks, staff, status, dateRelease.</p>
    <div class="toolbar">
      <a class="ghost" href="/tickets-import-template.csv" download style="text-decoration:none;padding:10px 14px;border-radius:10px">Download CSV Template</a>
      <input id="csvFile" type="file" accept=".csv">
      <button class="ghost" id="parseCsv">Preview</button>
      <button class="primary" id="importCsv">Import</button>
    </div>
    <div id="csvSummary" class="muted"></div>
    <pre id="csvPreview" style="max-height:220px;overflow:auto;background:#0b1324;border:1px solid #1f2937;border-radius:10px;padding:10px;margin-top:10px"></pre>
  </div>
</div>

<script>
// Surface JS errors to help diagnose
window.addEventListener('error', e => { const m=document.getElementById('msg'); if(m){ m.textContent = 'Script error: ' + e.message; } });

async function readErr(r){const ct=r.headers.get('content-type')||'';if(ct.includes('application/json')){try{const j=await r.json();return j.error||JSON.stringify(j)}catch{}}try{return (await r.text()).slice(0,400)}catch{return r.statusText}}

async function postTicket(doc){
  const r=await fetch('/api/ticket',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(doc)});
  if(!r.ok){ throw new Error(await readErr(r)); }
  return r.json();
}

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const doc={ studentId: sid.value.trim(), studentName: sname.value.trim(), requestType: rtype.value.trim(),
      dateReceived: new Date(dr.value).toISOString(), scheduleRelease: sched.value? new Date(sched.value).toISOString(): null,
      targetDays: target.value? Number(target.value): null, remarks: remarks.value.trim(), staff: staff.value.trim(), status: 'Received' };
    const out=await postTicket(doc);
    msg.textContent='Saved ticket '+(out.ref||out._id);
    e.target.reset();
  }catch(err){ msg.textContent='Save failed: '+err.message; }
});

document.getElementById('saveOutgoing').onclick=async()=>{
  if(!sname.value||!rtype.value||!dr.value){ alert('Fill Student Name, Type, and Date Received'); return; }
  try{
    const doc={ studentId: sid.value.trim(), studentName: sname.value.trim(), requestType: rtype.value.trim(),
      dateReceived: new Date(dr.value).toISOString(), scheduleRelease: sched.value? new Date(sched.value).toISOString(): null,
      targetDays: target.value? Number(target.value): null, remarks: remarks.value.trim(), staff: staff.value.trim(),
      dateRelease: new Date().toISOString(), status: 'Released' };
    const out=await postTicket(doc);
    msg.textContent='Saved outgoing ticket '+(out.ref||out._id);
    form.reset();
  }catch(err){ msg.textContent='Save failed: '+err.message; }
};

document.getElementById('exportBtn').onclick=async()=>{
  try{
    const r=await fetch('/api/ticket?limit=1000'); if(!r.ok) return alert(await readErr(r));
    const rows=await r.json(); if(!rows.length) return alert('No data to export.');
    const headers=['_id','ref','studentId','studentName','requestType','dateReceived','scheduleRelease','dateRelease','processingDays','targetDays','remarks','staff','status','createdAt'];
    const csv=[headers.join(',')];
    for(const t of rows){csv.push(headers.map(h=>`"${(t[h]??'').toString().replace(/"/g,'""')}"`).join(','));}
    const blob=new Blob([csv.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='tickets-entry-export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
  }catch(e){alert(String(e));}
};

// ---- CSV Import helpers (FIXED: use '\n' and '\r' not literal newlines) ----
function parseCSV(text){
  const rows=[]; let i=0, field='', row=[], inQuotes=false;
  function pushField(){ row.push(field); field=''; }
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c==='"'){
        if(text[i+1]==='"'){ field+='"'; i+=2; continue; }
        inQuotes=false; i++; continue;
      } else { field+=c; i++; continue; }
    } else {
      if(c==='"'){ inQuotes=true; i++; continue; }
      if(c===','){ pushField(); i++; continue; }
      if(c==='\n'){ pushField(); rows.push(row); row=[]; i++; continue; }
      if(c==='\r'){ i++; continue; }
      field+=c; i++;
    }
  }
  if(field!=='' || row.length){ pushField(); rows.push(row); }
  if(rows.length && rows[rows.length-1].every(x=>x==='' )) rows.pop();
  return rows;
}
function headerMap(headers){
  const m={}, norm = s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'').trim();
  headers.forEach((h,idx)=>{
    const k=norm(h);
    if(['studentid','id'].includes(k)) m['studentId']=idx;
    else if(['studentname','name','fullname'].includes(k)) m['studentName']=idx;
    else if(['requesttype','type'].includes(k)) m['requestType']=idx;
    else if(['datereceived','received','receivedat'].includes(k)) m['dateReceived']=idx;
    else if(['schedulerelease','scheduleforrelease','schedule','releaseplan'].includes(k)) m['scheduleRelease']=idx;
    else if(['targetdays','target','targettime','targettimeindays'].includes(k)) m['targetDays']=idx;
    else if(['remarks','notes','comment'].includes(k)) m['remarks']=idx;
    else if(['staff','staffincharge','staffinchg','staffname'].includes(k)) m['staff']=idx;
    else if(['status','state'].includes(k)) m['status']=idx;
    else if(['daterelease','released','releasedat'].includes(k)) m['dateRelease']=idx;
  });
  return m;
}
function cell(row, idx){ return (idx!=null && idx<row.length) ? row[idx].trim() : ''; }
function toISOorNull(v){
  if(!v) return null;
  const d = new Date(v);
  if(!isNaN(d.valueOf())) return d.toISOString();
  const m = v.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})(?::(\d{2}))?$/);
  if(m){ const s = m[1]+'T'+m[2]+(m[3]?':'+m[3]:'')+':00'; const d2=new Date(s); if(!isNaN(d2.valueOf())) return d2.toISOString(); }
  return null;
}
let _csvDocs=[];

document.getElementById('parseCsv').onclick=async()=>{
  const f = document.getElementById('csvFile').files[0];
  if(!f) return alert('Choose a CSV file first.');
  const text = await f.text();
  const rows = parseCSV(text);
  if(!rows.length) return alert('Empty CSV.');
  const headers = rows[0]; const map = headerMap(headers);
  const docs = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r]; if(row.every(x=>x.trim()==='')) continue;
    const doc = {
      studentId: cell(row, map.studentId),
      studentName: cell(row, map.studentName),
      requestType: cell(row, map.requestType),
      dateReceived: toISOorNull(cell(row, map.dateReceived)),
      scheduleRelease: toISOorNull(cell(row, map.scheduleRelease)),
      targetDays: (cell(row, map.targetDays) || '') ? Number(cell(row, map.targetDays)) : null,
      remarks: cell(row, map.remarks),
      staff: cell(row, map.staff),
      status: cell(row, map.status),
      dateRelease: toISOorNull(cell(row, map.dateRelease)),
    };
    if(!doc.status){ doc.status = doc.dateRelease ? 'Released' : 'Received'; }
    docs.push(doc);
  }
  _csvDocs = docs;
  const preview = docs.slice(0,5).map(d=>JSON.stringify(d,null,2)).join('\n---\n');
  document.getElementById('csvPreview').textContent = preview || '(no rows)';
  document.getElementById('csvSummary').textContent = `Parsed ${docs.length} row(s). Only the first 5 are shown below.`;
};

document.getElementById('importCsv').onclick=async()=>{
  if(!_csvDocs.length) return alert('Nothing to import. Click Preview first.');
  if(!confirm('Import '+_csvDocs.length+' rows?')) return;
  let ok=0, fail=0, errs=[];
  for(const doc of _csvDocs){
    const payload = { ...doc };
    if(!payload.studentName || !payload.requestType){
      fail++; errs.push('Missing required fields: '+JSON.stringify(doc)); continue;
    }
    if(!payload.dateReceived) payload.dateReceived = new Date().toISOString();
    try{
      const r = await fetch('/api/ticket',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok){ fail++; errs.push(await readErr(r)); } else { ok++; }
    }catch(e){ fail++; errs.push(String(e)); }
  }
  document.getElementById('csvSummary').textContent = `Imported ${ok} / ${_csvDocs.length}. Errors: ${fail}`;
  if(errs.length){ document.getElementById('csvPreview').textContent = errs.slice(0,20).join('\n'); }
};
</script>
</body>
</html>
